<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #chat {
            width: 400px;
            height: 200px;
            border: solid 1px gray;
            overflow-y: scroll;
        }
        #msg { width: 280px; }
        p { margin: .3em .5em; }
        .time { color: gray; }
        .nick-server { color: red; }
        .nick-client { color: blue; }
    </style>
    <title>Chat</title>
</head>
<body>
    <div id="chat"></div>
    <form>
    <input type="text" name="msg" id="msg" value="" autofocus="autofocus" />
    <input type="submit" value="send" onclick="send();return false" />
    <a href="javascript:logout()">logout</a>
    </form>
    <div id='nick-list'></div>
    <script>
        var socket = io.connect();
        var nick = get_nick();
        var chat = document.getElementById('chat');
        var msg = document.getElementById('msg');
        var storage = {'history': []};
        var init = true;

        // login into chat
        socket.emit('login', { 'nick': nick });

        socket.on('chat', function (data) {
            console.log(data.nick + ':' + data.msg);
            if (data.error)
                location.href = '/?error=' + data.msg;
            else {
                if (init) {
                    init = false;
                    load_history();
                }
                chat.innerHTML += get_html(data);
                save_history(data);
                location.href = '#' + data.time; // go to end of chat
            }
            msg.focus();
        });

        socket.on('nickList', function (data) {
            var html = '';
            for (var i=0; i<data.nicks.length; i++) {
                html += '<li>' + data.nicks[i] + '</li>';
            }
            html = '<ul>' + html + '</ul>';
            document.getElementById('nick-list').innerHTML = html;
            console.log(data.nicks);
        });

        function get_nick () {
            nick = location.search.substring(1).split('=')[1];
            nick = unescape(nick);
            nick = nick.replace(/\+/g, ' '); // + to space
            nick = nick.replace(/^\s+/g, '').replace(/\s+$/g, ''); // trim
            nick = nick.replace(/ +/g, '_'); // space to _
            return nick;
        }

        function get_html (data) {
            var time = '<span class="time">[' + ftime(data.time) + ']</span> ';
            var nick_class = (data.nick == 'SERVER') ? 'nick-server' : 'nick-client';
            var nick = '<span class="' + nick_class + '">' + data.nick + '</span>';
            var msg = '<span class="msg">' + data.msg + '</span>';
            var anchor = '<a name="' + data.time + '"></a>';
            return anchor + '<p>' + time + '&lt;' + nick + '&gt; ' + msg + '</p>';
        }

        function ftime (time) {
            var t = new Date(time);
            var hour = t.getHours();
            if (hour < 10) hour = '0' + hour;
            var min = t.getMinutes();
            if (min < 10) min = '0' + min;
            return hour + ':' + min;
        }

        function send () {
            socket.emit('msg', {'msg': msg.value});
            msg.value = '';
            msg.focus();
        }

        function logout () {
            if (confirm('Leave the chat?')) {
                socket.emit('logout', { 'nick': nick });
                location.href = '/';
            }
        }

        function save_history (data) {
            var _storage = JSON.parse(localStorage.getItem(nick));
            if (!_storage) {
                _storage = storage;
            }
            _storage.history.push(data);
            if (_storage.history.length > 10) {
                _storage.history.splice(0, 1);
            }
            localStorage.setItem(nick, JSON.stringify(_storage));
        }

        function load_history () {
            var _storage = JSON.parse(localStorage.getItem(nick));
            if (_storage) {
                for (var i=0; i<_storage.history.length; i++) {
                    chat.innerHTML += get_html(_storage.history[i]);
                }
            }
        }

    </script>
</body>
</html>
