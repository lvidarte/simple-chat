<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #chat {
            font-family: Courier, "Courier New", monospace;
            font-size: 16px;
            width: 500px;
            height: 350px;
            border: solid 1px gray;
            overflow-y: scroll;
        }
        #msg { width: 300px; }
        p { margin: .3em .5em; }
        .time { color: gray; }
        .nick-server { color: red; }
        .nick-normal { color: blue; }
        .nick-private { color: green; }
        a.nick {
            color: inherit;
            text-decoration: none;
        }
    </style>
    <title>Chat</title>
</head>
<body>
    <div id="chat"></div>
    <form onsubmit="send();return false">
    <input type="text" name="msg" id="msg" value="" autofocus="autofocus" />
    <input type="submit" value="send" />
    <a href="javascript:exportHistory()">export</a>
    <a href="javascript:logout()">logout</a>
    </form>
    <div id='nick-list'></div>
    <script>
        // Settings
        var marks_time = ['[', '] '];
        var marks_nick_public_msg = ['', ': '];
        var marks_nick_private_msg_to = ['»', ': '];
        var marks_nick_private_msg_from = ['«', ': '];

        var socket = io.connect();
        var nick = get_nick_from_url();
        var chat = document.getElementById('chat');
        var msg = document.getElementById('msg');
        var storage_json_tpl = {'history': []};
        var init = true;

        // login into chat
        socket.emit('login', { 'nick': nick });

        socket.on('chat', function (data) {
            console.log(data.nick + ': ' + data.msg);
            if (data.error)
                location.href = '/?error=' + data.msg;
            else {
                if (init) {
                    init = false;
                    load_history();
                }
                chat.innerHTML += get_html(data);
                save_history(data);
                location.href = '#' + data.time; // go to end of chat
            }
            msg.focus();
        });

        socket.on('nickList', function (data) {
            console.log(data.nicks);
            var html = ''
            for (var i=0; i<data.nicks.length; i++) {
                _nick = data.nicks[i];
                if (_nick != nick) {
                    _nick = '<a href="javascript:private(\'' + _nick + '\')">'
                          + _nick + '</a>';
                }
                html += '<li>' + _nick + '</li>';
            }
            html = '<ul>' + html + '</ul>';
            document.getElementById('nick-list').innerHTML = html;
        });

        function get_nick_from_url () {
            _nick = location.search.substring(1).split('=')[1];
            _nick = unescape(_nick);
            _nick = _nick.replace(/\+/g, ' '); // + to space
            _nick = _nick.replace(/^\s+/g, '').replace(/\s+$/g, ''); // trim
            _nick = _nick.replace(/ +/g, '_'); // space to _
            return _nick;
        }

        function private (nick) {
            msg.value = '/msg ' + nick + ' ';
            msg.focus();
        }

        function get_html (data) {
            var anchor = '<a name="' + data.time + '"></a>';
            var _time = marks_time[0] + ftime(data.time) + marks_time[1];
            var html_time = '<span class="time">' + _time + '</span>';
            var _nick = get_nick(data);
            if (data.type != 'server' && _nick != nick) {
                _nick = '<a href="javascript:private(\'' + _nick + '\')"'
                      + 'class="nick">' + _nick + '</a>';
            }
            var marks_nick = get_marks_nick(data);
            var nick_class = 'nick-' + data.type;
            var html_nick = '<span class="' + nick_class + '">' + _nick + '</span>';
            html_nick = marks_nick[0] + html_nick + marks_nick[1];
            var html_msg = '<span class="msg">' + data.msg + '</span>';
            return anchor + '<p>' + html_time + html_nick + html_msg + '</p>';
        }

        function ftime (time) {
            var t = new Date(time);
            var hour = t.getHours();
            if (hour < 10) hour = '0' + hour;
            var min = t.getMinutes();
            if (min < 10) min = '0' + min;
            return hour + ':' + min;
        }

        function send () {
            socket.emit('msg', {'msg': msg.value});
            msg.value = '';
            msg.focus();
        }

        function logout () {
            if (confirm('Leave the chat?')) {
                socket.emit('logout', { 'nick': nick });
                location.href = '/';
            }
        }

        function save_history (data) {
            var _storage = JSON.parse(localStorage.getItem(nick));
            var _sessionStorage = JSON.parse(sessionStorage.getItem(nick));
            if (!_storage) {
                _storage = storage_json_tpl;
            }
            if (!_sessionStorage) {
                _sessionStorage = storage_json_tpl;
            }
            _storage.history.push(data);
            _sessionStorage.history.push(data);
            if (_storage.history.length > 10) {
                _storage.history.splice(0, 1);
            }
            localStorage.setItem(nick, JSON.stringify(_storage));
            sessionStorage.setItem(nick, JSON.stringify(_sessionStorage));
        }

        function load_history () {
            var _storage = JSON.parse(localStorage.getItem(nick));
            if (_storage) {
                for (var i=0; i<_storage.history.length; i++) {
                    chat.innerHTML += get_html(_storage.history[i]);
                }
                sessionStorage.setItem(nick, JSON.stringify(_storage));
            }
        }

        function exportHistory () {
            _sessionStorage = JSON.parse(sessionStorage.getItem(nick));
            content = "Export @ " + Date().toLocaleString() + "\n";
            for (var i=0; i<_sessionStorage.history.length; i++) {
                var data = _sessionStorage.history[i];
                var marks_nick = get_marks_nick(data);
                var _nick = get_nick(data);
                content += marks_time[0] + ftime(data.time) + marks_time[1];
                content += marks_nick[0] + _nick + marks_nick[1];
                content += data.msg + "\n";
            }
            uriContent = "data:application/octet-stream,"; 
            uriContent += encodeURIComponent(content + "\n");
            location.href = uriContent;
            //window.open(uriContent, 'chat.txt');
        }

        function get_marks_nick (data) {
            if (data.type == 'private') {
                if (data.nick == nick) {
                    return marks_nick_private_msg_to;
                }
                return marks_nick_private_msg_from;
            }
            return marks_nick_public_msg;
        }

        function get_nick (data) {
            if (data.type == 'private' && data.nick == nick) {
                return data.to;
            }
            return data.nick;
        }
    </script>
</body>
</html>
